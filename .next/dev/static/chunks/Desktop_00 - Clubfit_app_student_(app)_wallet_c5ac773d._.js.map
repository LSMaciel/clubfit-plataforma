{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carolina/Desktop/00%20-%20Clubfit/app/student/%28app%29/wallet/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getStudentSession } from '@/utils/auth-student'\r\nimport { randomUUID } from 'crypto'\r\n\r\nexport async function generateWalletToken() {\r\n    const session = await getStudentSession()\r\n    if (!session || !session.studentId) {\r\n        return { error: 'Sessão inválida.' }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    // 1. Gerar Token Seguro (UUID)\r\n    const token = randomUUID()\r\n\r\n    // 2. Definir Expiração (5 minutos)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString()\r\n\r\n    // 3. Salvar no Banco\r\n    const { error } = await supabase\r\n        .from('student_access_tokens')\r\n        .insert({\r\n            student_id: session.studentId,\r\n            token: token,\r\n            expires_at: expiresAt,\r\n            benefit_id: null, // Token Genérico\r\n            status: 'PENDING'\r\n        })\r\n\r\n    if (error) {\r\n        console.error('Erro ao gerar token:', error)\r\n        return { error: 'Falha ao gerar cartão digital.' }\r\n    }\r\n\r\n    return { token, expiresAt }\r\n}\r\n"],"names":[],"mappings":";;;;;;;IAMsB,sBAAA,WAAA,GAAA,IAAA,kRAAA,EAAA,8CAAA,uQAAA,EAAA,KAAA,GAAA,6QAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carolina/Desktop/00%20-%20Clubfit/app/student/%28app%29/wallet/page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport QRCode from 'react-qr-code'\r\nimport { generateWalletToken } from './actions'\r\nimport Link from 'next/link'\r\n\r\nexport default function WalletPage() {\r\n    const [token, setToken] = useState<string | null>(null)\r\n    const [expiresAt, setExpiresAt] = useState<Date | null>(null)\r\n    const [timeLeft, setTimeLeft] = useState<number>(0)\r\n    const [loading, setLoading] = useState(true)\r\n    const [error, setError] = useState<string | null>(null)\r\n\r\n    // Função para carregar novo token\r\n    async function loadToken() {\r\n        setLoading(true)\r\n        setError(null)\r\n        setToken(null) // Clear previous to avoid confusion\r\n\r\n        try {\r\n            const result = await generateWalletToken()\r\n            if (result.error) {\r\n                setError(result.error)\r\n            } else {\r\n                setToken(result.token!)\r\n                const expiry = new Date(result.expiresAt!)\r\n                setExpiresAt(expiry)\r\n                // Calcular tempo restante em segundos\r\n                const secondsLeft = Math.floor((expiry.getTime() - Date.now()) / 1000)\r\n                setTimeLeft(Math.max(0, secondsLeft))\r\n            }\r\n        } catch (err) {\r\n            setError('Erro de conexão.')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    // Effect inicial\r\n    useEffect(() => {\r\n        loadToken()\r\n    }, [])\r\n\r\n    // Contador Regressivo\r\n    useEffect(() => {\r\n        if (!expiresAt || timeLeft <= 0) return\r\n\r\n        const interval = setInterval(() => {\r\n            const seconds = Math.floor((expiresAt.getTime() - Date.now()) / 1000)\r\n            setTimeLeft(Math.max(0, seconds))\r\n        }, 1000)\r\n\r\n        return () => clearInterval(interval)\r\n    }, [expiresAt, timeLeft])\r\n\r\n    // Formatar Tempo MM:SS\r\n    const formatTime = (seconds: number) => {\r\n        const m = Math.floor(seconds / 60)\r\n        const s = seconds % 60\r\n        return `${m}:${s.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    const isExpired = timeLeft <= 0 && !loading\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 flex flex-col items-center pt-8 px-4\">\r\n            {/* Header com Voltar */}\r\n            <div className=\"w-full max-w-md mb-8 flex items-center\">\r\n                <Link href=\"/student/dashboard\" className=\"text-[var(--primary-color)] flex items-center gap-2 font-medium\">\r\n                    ← Voltar\r\n                </Link>\r\n                <h1 className=\"flex-1 text-center font-bold text-slate-800 text-lg mr-8\">\r\n                    Carteira Digital\r\n                </h1>\r\n            </div>\r\n\r\n            {/* Card do QR Code */}\r\n            <div className=\"w-full max-w-sm bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 flex flex-col items-center p-8 relative\">\r\n\r\n                {/* Status Bar Superior */}\r\n                <div className=\"w-full flex justify-between items-center mb-6\">\r\n                    <span className=\"text-sm text-slate-400 font-medium\">Token de Acesso</span>\r\n                    {loading ? (\r\n                        <span className=\"text-xs text-slate-400 animate-pulse\">Gerando...</span>\r\n                    ) : (\r\n                        <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${isExpired ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>\r\n                            {isExpired ? 'EXPIRADO' : 'VÁLIDO'}\r\n                        </span>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Área do QR Code */}\r\n                <div className=\"relative w-64 h-64 bg-slate-50 rounded-2xl flex items-center justify-center p-4 border border-slate-100\">\r\n                    {loading && (\r\n                        <div className=\"absolute inset-0 flex items-center justify-center bg-white/80 z-10\">\r\n                            <div className=\"w-8 h-8 border-4 border-[var(--primary-color)] border-t-transparent rounded-full animate-spin\"></div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {error && (\r\n                        <div className=\"text-center text-red-500 text-sm px-4\">\r\n                            <p className=\"font-bold mb-2\">Erro</p>\r\n                            {error}\r\n                            <button onClick={loadToken} className=\"mt-4 text-xs underline\">Tentar novamente</button>\r\n                        </div>\r\n                    )}\r\n\r\n                    {!loading && !error && token && !isExpired && (\r\n                        <QRCode\r\n                            value={token}\r\n                            size={220}\r\n                            viewBox={`0 0 256 256`}\r\n                            fgColor=\"#1e293b\" // slate-800\r\n                        />\r\n                    )}\r\n\r\n                    {isExpired && !loading && (\r\n                        <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-white/95 z-20 text-center\">\r\n                            <p className=\"text-slate-400 font-bold mb-2\">Token Expirado</p>\r\n                            <button\r\n                                onClick={loadToken}\r\n                                className=\"px-6 py-2 bg-[var(--primary-color)] text-white rounded-full font-bold shadow-lg active:scale-95 transition-all\"\r\n                            >\r\n                                Gerar Novo\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Timer */}\r\n                <div className=\"mt-8 text-center\">\r\n                    <p className=\"text-slate-400 text-sm mb-1\">Este código expira em</p>\r\n                    <p className={`text-3xl font-mono font-bold ${timeLeft < 10 ? 'text-red-500' : 'text-slate-800'}`}>\r\n                        {formatTime(timeLeft)}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Instrução */}\r\n            <p className=\"mt-8 text-center text-slate-400 text-sm max-w-xs mx-auto\">\r\n                Apresente este QR Code ao parceiro para validar seu benefício ou entrada.\r\n            </p>\r\n        </div>\r\n    )\r\n}\r\n"],"names":[],"mappings":"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"}}]
}