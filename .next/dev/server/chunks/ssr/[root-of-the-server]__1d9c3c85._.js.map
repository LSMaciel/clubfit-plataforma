{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carolina/Desktop/00%20-%20Clubfit/app/admin/partners/actions.ts"],"sourcesContent":["\n'use server'\n\nimport { createClient } from '@/utils/supabase/server'\nimport { createAdminClient } from '@/utils/supabase/admin'\nimport { redirect } from 'next/navigation'\nimport { revalidatePath } from 'next/cache'\n\nexport async function createPartner(prevState: any, formData: FormData) {\n  const supabase = await createClient()\n  const supabaseAdmin = createAdminClient()\n\n  // 1. Identificar quem está logado (O Admin da Academia)\n  const { data: { user: currentUser } } = await supabase.auth.getUser()\n  if (!currentUser) return { error: 'Não autenticado.' }\n\n  // Buscar dados do perfil para saber qual academia ele gerencia\n  const { data: adminProfile } = await supabase\n    .from('users')\n    .select('role, academy_id')\n    .eq('id', currentUser.id)\n    .single()\n\n  // Validação de Permissão\n  if (!adminProfile || !['ACADEMY_ADMIN', 'SUPER_ADMIN'].includes(adminProfile.role)) {\n    return { error: 'Permissão negada. Apenas Admins de Academia podem cadastrar parceiros.' }\n  }\n\n  if (!adminProfile.academy_id) {\n    return { error: 'Usuário não vinculado a uma academia.' }\n  }\n\n  // 2. Dados do Formulário\n  const partnerName = formData.get('partner_name') as string\n  const address = formData.get('address') as string\n  const description = formData.get('description') as string\n\n  const ownerName = formData.get('owner_name') as string\n  const ownerEmail = formData.get('owner_email') as string\n  const ownerPassword = formData.get('owner_password') as string\n\n  if (!partnerName || !ownerEmail || !ownerPassword || !ownerName) {\n    return { error: 'Preencha todos os campos obrigatórios.' }\n  }\n\n  // 3. Criar Usuário Auth (Usando Admin Client para não perder sessão atual)\n  // email_confirm: true evita que o usuário fique preso no envio de email\n  const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({\n    email: ownerEmail,\n    password: ownerPassword,\n    email_confirm: true,\n    user_metadata: { full_name: ownerName }\n  })\n\n  if (authError) {\n    console.error('Erro Auth:', authError)\n    return { error: `Erro ao criar login: ${authError.message}` }\n  }\n\n  const newUserId = authData.user.id\n\n  // 4. Criar Perfil Público (public.users)\n  const { error: profileError } = await supabaseAdmin\n    .from('users')\n    .insert({\n      id: newUserId,\n      name: ownerName,\n      role: 'PARTNER',\n      academy_id: adminProfile.academy_id\n    })\n\n  if (profileError) {\n    // Rollback manual (deletar user criado se falhar perfil)\n    await supabaseAdmin.auth.admin.deleteUser(newUserId)\n    console.error('Erro Profile:', profileError)\n    return { error: 'Erro ao criar perfil do parceiro.' }\n  }\n\n  // 5. Criar Registro do Parceiro (public.partners)\n  const { error: partnerError } = await supabaseAdmin\n    .from('partners')\n    .insert({\n      academy_id: adminProfile.academy_id,\n      owner_id: newUserId,\n      name: partnerName,\n      address: address,\n      description: description\n    })\n\n  if (partnerError) {\n    console.error('Erro Partner:', partnerError)\n    return { error: 'Erro ao criar dados da empresa parceira.' }\n  }\n\n  revalidatePath('/admin/partners')\n  redirect('/admin/partners')\n}\n"],"names":[],"mappings":";;;;;;;IAQsB,gBAAA,WAAA,GAAA,IAAA,+QAAA,EAAA,8CAAA,oQAAA,EAAA,KAAA,GAAA,0QAAA,EAAA"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carolina/Desktop/00%20-%20Clubfit/components/ui/form-input.tsx"],"sourcesContent":["import React from 'react'\n\ninterface FormInputProps extends React.InputHTMLAttributes<HTMLInputElement> {\n  label: string\n  name: string\n  error?: string\n}\n\nexport function FormInput({ label, name, error, className = '', ...props }: FormInputProps) {\n  return (\n    <div className=\"w-full\">\n      <label htmlFor={name} className=\"block text-sm font-medium text-slate-700 mb-1\">\n        {label}\n      </label>\n      <input\n        id={name}\n        name={name}\n        className={`\n          block w-full rounded-md border-slate-300 shadow-sm \n          focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm\n          border p-2\n          ${error ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : ''}\n          ${className}\n        `}\n        {...props}\n      />\n      {error && <p className=\"mt-1 text-sm text-red-600\">{error}</p>}\n    </div>\n  )\n}"],"names":[],"mappings":";;;;;;AAQO,SAAS,UAAU,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,YAAY,EAAE,EAAE,GAAG,OAAuB;IACxF,qBACE,8QAAC;QAAI,WAAU;;0BACb,8QAAC;gBAAM,SAAS;gBAAM,WAAU;0BAC7B;;;;;;0BAEH,8QAAC;gBACC,IAAI;gBACJ,MAAM;gBACN,WAAW,CAAC;;;;UAIV,EAAE,QAAQ,2DAA2D,GAAG;UACxE,EAAE,UAAU;QACd,CAAC;gBACA,GAAG,KAAK;;;;;;YAEV,uBAAS,8QAAC;gBAAE,WAAU;0BAA6B;;;;;;;;;;;;AAG1D"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carolina/Desktop/00%20-%20Clubfit/app/admin/partners/new/page.tsx"],"sourcesContent":["\n'use client'\n\nimport { createPartner } from '../actions'\nimport { FormInput } from '@/components/ui/form-input'\nimport Link from 'next/link'\nimport { useState } from 'react'\n\nexport default function NewPartnerPage() {\n  const [error, setError] = useState<string | null>(null)\n\n  async function handleSubmit(formData: FormData) {\n    setError(null)\n    const result = await createPartner(null, formData)\n    if (result?.error) {\n      setError(result.error)\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-50 flex flex-col\">\n       <nav className=\"bg-white border-b border-slate-200 px-8 py-4\">\n        <div className=\"max-w-3xl mx-auto flex items-center gap-4\">\n            <Link href=\"/admin/partners\" className=\"text-sm text-slate-500 hover:text-slate-900\">\n                ← Voltar\n            </Link>\n            <h1 className=\"font-bold text-xl text-slate-900\">Novo Parceiro</h1>\n        </div>\n      </nav>\n\n      <main className=\"flex-1 p-8\">\n        <div className=\"max-w-3xl mx-auto\">\n            <div className=\"bg-white rounded-xl shadow-sm border border-slate-200 p-8\">\n                <form action={handleSubmit} className=\"space-y-8\">\n                    \n                    {/* Seção 1: Dados da Empresa */}\n                    <div>\n                        <h2 className=\"text-lg font-bold text-slate-800 mb-4 border-b pb-2\">Dados do Estabelecimento</h2>\n                        <div className=\"grid grid-cols-1 gap-6\">\n                            <FormInput \n                                label=\"Nome Fantasia\" \n                                name=\"partner_name\" \n                                placeholder=\"Ex: Pizzaria do Zé\" \n                                required \n                            />\n                            <FormInput \n                                label=\"Endereço Completo\" \n                                name=\"address\" \n                                placeholder=\"Rua X, 123 - Centro\" \n                            />\n                            <div className=\"w-full\">\n                                <label htmlFor=\"description\" className=\"block text-sm font-medium text-slate-700 mb-1\">\n                                    Descrição Curta (Categoria)\n                                </label>\n                                <textarea\n                                    id=\"description\"\n                                    name=\"description\"\n                                    rows={3}\n                                    className=\"block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2\"\n                                    placeholder=\"Ex: Pizzaria artesanal com desconto para alunos.\"\n                                />\n                            </div>\n                        </div>\n                    </div>\n\n                    {/* Seção 2: Dados de Acesso */}\n                    <div>\n                        <h2 className=\"text-lg font-bold text-slate-800 mb-4 border-b pb-2\">Acesso do Responsável (Dono)</h2>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                            <FormInput \n                                label=\"Nome do Responsável\" \n                                name=\"owner_name\" \n                                placeholder=\"Nome Completo\" \n                                required \n                            />\n                             <div className=\"hidden md:block\"></div> {/* Spacer */}\n                            <FormInput \n                                label=\"E-mail de Login\" \n                                name=\"owner_email\" \n                                type=\"email\"\n                                placeholder=\"admin@pizzaria.com\" \n                                required \n                            />\n                            <FormInput \n                                label=\"Senha Inicial\" \n                                name=\"owner_password\" \n                                type=\"text\" // Mostrar texto para facilitar cadastro\n                                placeholder=\"Mínimo 6 caracteres\" \n                                required \n                                minLength={6}\n                            />\n                        </div>\n                        <p className=\"mt-2 text-xs text-slate-500 bg-blue-50 p-2 rounded text-center\">\n                            ℹ️ Guarde esta senha. O parceiro usará este e-mail e senha para acessar o painel de promoções.\n                        </p>\n                    </div>\n\n                    {error && (\n                        <div className=\"bg-red-50 text-red-600 p-4 rounded-md text-sm border border-red-100\">\n                            {error}\n                        </div>\n                    )}\n\n                    <div className=\"pt-4 flex justify-end gap-3\">\n                        <Link \n                            href=\"/admin/partners\"\n                            className=\"px-4 py-2 border border-slate-300 rounded-md text-slate-700 hover:bg-slate-50 text-sm font-medium\"\n                        >\n                            Cancelar\n                        </Link>\n                        <button\n                            type=\"submit\"\n                            className=\"px-4 py-2 bg-slate-900 text-white rounded-md hover:bg-slate-800 text-sm font-medium\"\n                        >\n                            Cadastrar Parceiro\n                        </button>\n                    </div>\n\n                </form>\n            </div>\n        </div>\n      </main>\n    </div>\n  )\n}\n"],"names":[],"mappings":";;;;;AAGA;AACA;AACA;AACA;AALA;;;;;;AAOe,SAAS;IACtB,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iPAAQ,EAAgB;IAElD,eAAe,aAAa,QAAkB;QAC5C,SAAS;QACT,MAAM,SAAS,MAAM,IAAA,iNAAa,EAAC,MAAM;QACzC,IAAI,QAAQ,OAAO;YACjB,SAAS,OAAO,KAAK;QACvB;IACF;IAEA,qBACE,8QAAC;QAAI,WAAU;;0BACZ,8QAAC;gBAAI,WAAU;0BACd,cAAA,8QAAC;oBAAI,WAAU;;sCACX,8QAAC,uMAAI;4BAAC,MAAK;4BAAkB,WAAU;sCAA8C;;;;;;sCAGrF,8QAAC;4BAAG,WAAU;sCAAmC;;;;;;;;;;;;;;;;;0BAIvD,8QAAC;gBAAK,WAAU;0BACd,cAAA,8QAAC;oBAAI,WAAU;8BACX,cAAA,8QAAC;wBAAI,WAAU;kCACX,cAAA,8QAAC;4BAAK,QAAQ;4BAAc,WAAU;;8CAGlC,8QAAC;;sDACG,8QAAC;4CAAG,WAAU;sDAAsD;;;;;;sDACpE,8QAAC;4CAAI,WAAU;;8DACX,8QAAC,+KAAS;oDACN,OAAM;oDACN,MAAK;oDACL,aAAY;oDACZ,QAAQ;;;;;;8DAEZ,8QAAC,+KAAS;oDACN,OAAM;oDACN,MAAK;oDACL,aAAY;;;;;;8DAEhB,8QAAC;oDAAI,WAAU;;sEACX,8QAAC;4DAAM,SAAQ;4DAAc,WAAU;sEAAgD;;;;;;sEAGvF,8QAAC;4DACG,IAAG;4DACH,MAAK;4DACL,MAAM;4DACN,WAAU;4DACV,aAAY;;;;;;;;;;;;;;;;;;;;;;;;8CAO5B,8QAAC;;sDACG,8QAAC;4CAAG,WAAU;sDAAsD;;;;;;sDACpE,8QAAC;4CAAI,WAAU;;8DACX,8QAAC,+KAAS;oDACN,OAAM;oDACN,MAAK;oDACL,aAAY;oDACZ,QAAQ;;;;;;8DAEX,8QAAC;oDAAI,WAAU;;;;;;gDAAwB;8DACxC,8QAAC,+KAAS;oDACN,OAAM;oDACN,MAAK;oDACL,MAAK;oDACL,aAAY;oDACZ,QAAQ;;;;;;8DAEZ,8QAAC,+KAAS;oDACN,OAAM;oDACN,MAAK;oDACL,MAAK;oDACL,aAAY;oDACZ,QAAQ;oDACR,WAAW;;;;;;;;;;;;sDAGnB,8QAAC;4CAAE,WAAU;sDAAiE;;;;;;;;;;;;gCAKjF,uBACG,8QAAC;oCAAI,WAAU;8CACV;;;;;;8CAIT,8QAAC;oCAAI,WAAU;;sDACX,8QAAC,uMAAI;4CACD,MAAK;4CACL,WAAU;sDACb;;;;;;sDAGD,8QAAC;4CACG,MAAK;4CACL,WAAU;sDACb;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAWzB"}}]
}